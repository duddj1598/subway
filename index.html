<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>써브웨이 준비/해동/마감 시스템 v.FINAL</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Modern & Clean Theme Colors */
        :root {
            --primary-color: #007bff; /* Fresh Blue */
            --secondary-color: #28a745; /* Green for success */
            --background-light: #f8f9fa; /* Light Gray Background */
            --surface-white: #ffffff; /* Card/Container White */
            --border-color: #e9ecef;
            --text-dark: #343a40;
            --alert-red: #dc3545;
        }

        body {
            font-family: 'Segoe UI', 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            background-color: var(--background-light);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1100px;
            margin: 20px auto;
            padding: 0 20px;
        }

        /* Header & Dashboard */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        .header h1 { font-size: 1.5rem; color: var(--text-dark); margin: 0; font-weight: 600; }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .metric-card {
            background-color: var(--surface-white);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--primary-color);
        }
        .metric-card.alert { border-left-color: var(--alert-red); }
        .metric-card h3 { font-size: 1rem; color: #6c757d; margin: 0 0 5px 0; font-weight: 500; }
        .metric-card .value { font-size: 1.8rem; font-weight: 700; color: var(--text-dark); }
        .metric-card .value.alert { color: var(--alert-red); }
        .metric-card .summary { font-size: 0.8rem; color: #999; margin-top: 5px; }

        /* Action Buttons */
        .action-buttons button { background-color: #6c757d; color: white; border: none; padding: 8px 15px; margin-left: 10px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: background-color 0.2s; }
        .action-buttons button:hover { background-color: #5a6268; }
        #reset-data { background-color: var(--alert-red); }
        #reset-data:hover { background-color: #c82333; }

        /* Tabs */
        .tab-menu { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; overflow-x: auto; }
        .tab-button { background: none; border: none; padding: 10px 15px; cursor: pointer; font-size: 1rem; font-weight: 500; color: #6c757d; border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; }
        .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: 600; }

        /* Content and Table */
        .tab-content { display: none; background-color: var(--surface-white); padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.05); }
        .tab-content.active { display: block; }
        .section-title { font-size: 1.25rem; font-weight: 600; color: var(--text-dark); margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }

        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { border: 1px solid var(--border-color); padding: 10px; text-align: center; }
        th { background-color: var(--background-light); color: var(--text-dark); font-weight: 600; }

        input[type="number"], input[type="text"] { width: 100%; padding: 6px 0; box-sizing: border-box; border: none; border-bottom: 1px solid var(--border-color); text-align: center; transition: border-color 0.2s; }
        input[type="number"]:focus, input[type="text"]:focus { border-bottom-color: var(--primary-color); outline: none; }
        
        .need-count { font-weight: 700; color: var(--secondary-color); }
        .need-count.alert { color: var(--alert-red); background-color: #fff0f0; }

        /* Cash Settlement & Checklist */
        .cash-table th:nth-child(3), .cash-table th:nth-child(4) { width: 15%; }
        .cash-table th:nth-child(2), .cash-table th:nth-child(5) { width: 25%; }
        
        #cash-difference { font-size: 1.1rem; font-weight: 700; padding: 10px; display: block; margin-top: 10px; }
        #cash-difference.ok { color: var(--secondary-color); background-color: #e6ffe6; }
        #cash-difference.error { color: var(--alert-red); background-color: #fff0f0; }
        .cash-final-row td { font-weight: bold; background-color: #f0f0f0; }
        
        .checklist-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px dashed var(--border-color); cursor: pointer; }
        .checklist-item.done { text-decoration: line-through; color: #999; }
        
        /* 마감시트 야채 재고 3단 테이블 */
        .inventory-section { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .inventory-section h4 { border-bottom: 1px solid var(--border-color); padding-bottom: 5px; color: var(--primary-color); }
        .inventory-item td:first-child { font-weight: 500; }
    </style>
</head>
<body>
<div class="container">
    
    <div class="header">
        <h1>써브웨이 준비/해동/마감 <span style="font-size:0.8em; color:#6c757d;">v.FINAL</span></h1>
        <div class="action-buttons">
            <span style="font-size:0.9rem; color:#6c757d; margin-right:10px;">2025. 09. 26.</span> 
            <i class="fas fa-calendar-alt" style="margin-right: 15px;"></i>
            <button onclick="exportData()"><i class="fas fa-file-export"></i> 내보내기</button>
            <button onclick="printData()"><i class="fas fa-print"></i> 인쇄</button>
            <button id="reset-data" onclick="resetData()"><i class="fas fa-sync-alt"></i> 초기화</button>
        </div>
    </div>

    <div class="dashboard-grid" id="dashboard-metrics">
        </div>

    <div class="tab-menu">
        <button class="tab-button active" onclick="openTab(event, 'supplies')">마감비품표</button>
        <button class="tab-button" onclick="openTab(event, 'meat_thaw')">미트 해동표</button>
        <button class="tab-button" onclick="openTab(event, 'prep')">재료 준비표</button>
        <button class="tab-button" onclick="openTab(event, 'bread')">빵 해동표</button>
        <button class="tab-button" onclick="openTab(event, 'cash')">마감 시트표</button>
        <button class="tab-button" onclick="openTab(event, 'checklist')">마감 체크리스트</button>
    </div>

    <div id="supplies" class="tab-content active">
        <div class="section-title">마감 비품표</div>
        <table id="supplies-table">
            <thead>
                <tr><th>비품</th><th>기준 (수정)</th><th>현재</th><th>필요</th><th></th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="meat_thaw" class="tab-content">
        <div class="section-title">미트 해동표</div>
        <table id="meat-table">
            <thead>
                <tr><th>품목</th><th>기준 (수정)</th><th>현재</th><th>필요</th><th></th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="prep" class="tab-content">
        <div class="section-title">미트/재료 준비표</div>
        <table id="prep-table">
            <thead>
                <tr><th>품목</th><th>기준 (수정)</th><th>유니트</th><th>백냉</th><th>워크인</th><th>총 개수</th><th>필요</th><th></th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="bread" class="tab-content">
        <div class="section-title">빵 해동표</div>
        <p style="font-size:0.9em; margin-bottom: 20px; color:#888;">*파마산, 화이트, 하티는 화이트 빵을, 허니오트, 위트는 위트 빵의 재고를 사용합니다. 데이터는 빵 종류별로 입력해 주세요.</p>
        <table id="bread-table">
            <thead>
                <tr><th>품목</th><th>기준 (수정)</th><th>현재 재고</th><th>필요 개수</th>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="cash" class="tab-content">
        
        <div class="section-title">권종별 입/출금 상세</div>
        <table class="cash-table" style="margin-bottom: 20px;">
            <thead>
                <tr><th>권종</th><th>입금 (개수)</th><th>출금 (개수)</th><th>총 입금 (금액)</th><th>총 출금 (금액)</th></tr>
            </thead>
            <tbody id="cash-detail-table"></tbody>
            <tfoot>
                <tr class="cash-final-row">
                    <td>합계</td>
                    <td></td>
                    <td></td>
                    <td id="total-in">0 원</td>
                    <td id="total-out">0 원</td>
                </tr>
            </tfoot>
        </table>

        <div class="section-title">현금 정산 (마감 시트)</div>
        <table style="margin-bottom: 20px;">
            <thead>
                <tr><th style="width: 25%;">항목</th><th style="width: 25%;">설명</th><th style="width: 25%;">금액/개수</th><th style="width: 25%;">계산</th></tr>
            </thead>
            <tbody>
                <tr><td>(1) 현금매출</td><td>오늘 현금 매출</td><td><input type="number" id="cash-in-1" value="0" oninput="calculateCash()" /></td><td></td></tr>
                <tr><td>(2) 지출</td><td>금고에서 나간 지출 금액</td><td><input type="number" id="cash-out-2" value="0" oninput="calculateCash()" /></td><td></td></tr>
                <tr><td>(3) 금고출금</td><td>금고에서 가져온 금액</td><td><input type="number" id="cash-out-3" value="0" oninput="calculateCash()" /></td><td></td></tr>
                <tr class="cash-final-row"><td colspan="3">**최종 현금 잔액 (4) = (1) - (2) + (3)**</td><td><span id="cash-out-4" style="color: var(--primary-color);">0 원</span></td></tr>
                <tr><td colspan="3">**(5) 실제입금현금**</td><td><input type="number" id="cash-in-5" value="0" oninput="calculateCash()" /></td></tr>
                <tr><td colspan="3">**차액 ((5) - (4))**</td><td><span id="cash-difference" class="error">0 원</span></td></tr>
            </tbody>
        </table>
        
        <div class="section-title">지하/지상 재고 현황</div>
        <div class="inventory-section">
            <div>
                <h4>지하 (개수/볼)</h4>
                <table id="inv-basement"><tbody></tbody></table>
            </div>
            <div>
                <h4>지상 (KG/개수)</h4>
                <table id="inv-ground"><tbody></tbody></table>
            </div>
            <div>
                <h4>지상 (캠브로)</h4>
                <table id="inv-cambro"><tbody></tbody></table>
            </div>
        </div>
        
        <div class="section-title" style="margin-top: 30px;">기타 정산 및 메모</div>
        <div class="memo-area">
            <p><strong>식권대장:</strong> <input type="number" id="cash-etc-sik" value="0" oninput="saveEtcCash('sik')" placeholder="금액 입력" /></p>
            <p><strong>모드하우스:</strong> <input type="number" id="cash-etc-mod" value="0" oninput="saveEtcCash('mod')" placeholder="금액 입력" /></p>
            <p><strong>제로페이:</strong> <input type="number" id="cash-etc-zer" value="0" oninput="saveEtcCash('zer')" placeholder="금액 입력" /></p>
            <p><strong>계좌이체:</strong> <input type="number" id="cash-etc-acc" value="0" oninput="saveEtcCash('acc')" placeholder="금액 입력" /></p>

            <p style="font-weight:600; margin-top: 15px;">추가 메모 사항:</p>
            <textarea id="memo-field" placeholder="특이사항을 입력하세요." oninput="saveMemo('memo')"></textarea>
        </div>
    </div>

    <div id="checklist" class="tab-content">
        <div class="section-title">마감 체크리스트 (<span id="done-tasks">0</span>/<span id="total-tasks">0</span> 완료)</div>
        <div id="checklist-container"></div>
    </div>

</div>

<script>
    // **********************************************
    // JS Logic (Data & Functions)
    // **********************************************
    
    // 1. 초기 데이터 설정 (업데이트된 정보를 반영)
    const INITIAL_DATA = {
        // [1] 마감비품표
        supplies: [{ name: "음료컵", standard: 3, current: 0 }, { name: "음료뚜껑", standard: 3, current: 0 }, { name: "칵테일 냅킨", standard: 5, current: 0 }, { name: "키친타올", standard: 10, current: 0 }, { name: "숟가락", standard: 2, current: 0 }, { name: "포크", standard: 2, current: 0 }, { name: "나이프", standard: 2, current: 0 }, { name: "포카칩", standard: 3, current: 0 }, { name: "쿠키봉투", standard: 2, current: 0 }, { name: "아이스컵", standard: 1, current: 0 }, { name: "아이스컵뚜껑", standard: 1, current: 0 }, { name: "핫커피컵", standard: 1, current: 0 }, { name: "소 비닐봉투", standard: 2, current: 0 }, { name: "중 배달종이봉투", standard: 2, current: 0 }, { name: "대 배달종이봉투", standard: 2, current: 0 }, { name: "스프컵", standard: 1, current: 0 }, { name: "스프뚜껑", standard: 1, current: 0 }, { name: "종이쿠키팩", standard: 6, current: 0 }, { name: "쿠키박스", standard: 1, current: 0 }, { name: "종지", standard: 1, current: 0 }, { name: "종지뚜껑", standard: 1, current: 0 }, { name: "테이프", standard: 1, current: 0 }, { name: "케찹", standard: 1, current: 0 }, { name: "커홀더", standard: 1, current: 0 }, { name: "샐러드 볼", standard: 1, current: 0 }, { name: "샐러드 뚜껑", standard: 1, current: 0 }, { name: "음료 봉투", standard: 1, current: 0 }],
        // [2] 미트 해동표
        meat_thaw: [{ name: "치킨스트립", standard: 3, current: 0 }, { name: "치킨 패티", standard: 3, current: 0 }, { name: "폴드포크", standard: 4, current: 0 }, { name: "로티세리", standard: 4, current: 0 }, { name: "스테이크", standard: 6, current: 0 }, { name: "안창비프", standard: 10, current: 0 }, { name: "터키", standard: 6, current: 0 }, { name: "햄", standard: 6, current: 0 }, { name: "머쉬룸", standard: 6, current: 0 }, { name: "쉬림프", standard: 8, current: 0 }, { name: "페퍼로니", standard: 4, current: 0 }, { name: "살라미", standard: 4, current: 0 }, { name: "베이컨", standard: 2, current: 0 }, { name: "아보카도", standard: 24, current: 0 }, { name: "수프", standard: 3, current: 0 }, { name: "오믈렛", standard: 2, current: 0 }, { name: "비츠", standard: 1, current: 0 }],
        // [3] 미트재료준비표
        prep: [{ name: "치즈", standard: 4, unit: 0, back: 0, walk: 0 }, { name: "모짜렐라", standard: 4, unit: 0, back: 0, walk: 0 }, { name: "슈레드", standard: 6, unit: 0, back: 0, walk: 0 }, { name: "터키", standard: 3, unit: 0, back: 0, walk: 0 }, { name: "햄", standard: 4, unit: 0, back: 0, walk: 0 }, { name: "치킨패티", standard: 4, unit: 0, back: 0, walk: 0 }, { name: "베이컨", standard: 5, unit: 0, back: 0, walk: 0 }, { name: "쉬림프", standard: 4, unit: 0, back: 0, walk: 0 }, { name: "스파이시 쉬림프", standard: 2, unit: 0, back: 0, walk: 0 }, { name: "스테이크", standard: 3, unit: 0, back: 0, walk: 0 }, { name: "로티세리", standard: 3, unit: 0, back: 0, walk: 0 }, { name: "풀드포크", standard: 2, unit: 0, back: 0, walk: 0 }, { name: "살라미", standard: 4, unit: 0, back: 0, walk: 0 }, { name: "페러로니", standard: 4, unit: 0, back: 0, walk: 0 }, { name: "참치", standard: 2, unit: 0, back: 0, walk: 0 }, { name: "에그마요", standard: 8, unit: 0, back: 0, walk: 0 }, { name: "데리야끼", standard: 1, unit: 0, back: 0, walk: 0 }, { name: "안창", standard: 2, unit: 0, back: 0, walk: 0 }, { name: "머쉬룸", standard: 2, unit: 0, back: 0, walk: 0 }, { name: "아보카도", standard: 2, unit: 0, back: 0, walk: 0 }, { name: "피클", standard: 5, unit: 0, back: 0, walk: 0 }, { name: "올리브", standard: 5, unit: 0, back: 0, walk: 0 }, { name: "할라피뇨", standard: 5, unit: 0, back: 0, walk: 0 }],
        // [4] 빵 해동표
        bread: [{ name: "파마산", current: 0, defrost: 0, thaw_needed: 0, standard: 10 }, { name: "화이트", current: 0, defrost: 0, thaw_needed: 0, standard: 10 }, { name: "하티", current: 0, defrost: 0, thaw_needed: 0, standard: 10 }, { name: "허니오트", current: 0, defrost: 0, thaw_needed: 0, standard: 10 }, { name: "위트", current: 0, defrost: 0, thaw_needed: 0, standard: 10 }, { name: "플랫", current: 0, defrost: 0, thaw_needed: 0, standard: 10 }],
        // [5] 마감시트표: 현금, 기타, 야채 재고
        cash: { cash1000: 0, cash_out_2: 0, cash_out_3: 0, pos_cash: 0 },
        cash_detail: {
            "10000": { in: 0, out: 0 }, "50000": { in: 0, out: 0 }, "5000": { in: 0, out: 0 }, "1000": { in: 0, out: 0 }
        },
        inv_basement: [{ name: "샐러드볼", unit: "개", current: 0 }, { name: "또띠아", unit: "개", current: 0 }, { name: "플랫", unit: "개", current: 0 }, { name: "피망", unit: "개", current: 0 }, { name: "오이", unit: "개", current: 0 }, { name: "토마토", unit: "개", current: 0 }],
        inv_ground: [{ name: "또띠아", unit: "개", current: 0 }, { name: "플랫", unit: "개", current: 0 }, { name: "생지", unit: "개", current: 0 }, { name: "구운빵", unit: "개", current: 0 }, { name: "피망", unit: "KG", current: 0 }, { name: "오이", unit: "KG", current: 0 }, { name: "토마토", unit: "개", current: 0 }, { name: "양파", unit: "개", current: 0 }, { name: "깐계란", unit: "개", current: 0 }, { name: "양상추", unit: "개", current: 0 }],
        inv_cambro: [{ name: "피망", unit: "캠브로", current: 0 }, { name: "오이", unit: "캠브로", current: 0 }, { name: "토마토", unit: "캠브로", current: 0 }, { name: "양파", unit: "캠브로", current: 0 }],
        etc_cash: { sik: 0, mod: 0, zer: 0, acc: 0 },
        // [6] 마감 체크리스트
        checklist: ["소스마감", "전자레인지 마감", "쿠키마감", "유니트 밑 선반 청소", "유니트 유리 닦기", "오븐기, 발효기 마감", "소스 채우기", "비품 채우기", "비품 가져오기", "커피마감 + 커피물통", "백냉 음료 채우기", "핫웰 마감", "매장청소", "유니트끄기", "쓰레기통 합치기", "백냉 빼기", "음료 마감", "스쿱 걷기", "도마 및 빵칼 설거지", "유니트 마감"],
        checklist_status: {}
    };

    let data = {};
    const STORAGE_KEY = 'subway_close_data_v5_final';

    // 데이터 로드/저장
    function loadData() {
        const storedData = localStorage.getItem(STORAGE_KEY);
        if (storedData) {
            const loadedData = JSON.parse(storedData);
            data = Object.keys(INITIAL_DATA).reduce((acc, key) => {
                acc[key] = loadedData.hasOwnProperty(key) ? loadedData[key] : INITIAL_DATA[key];
                return acc;
            }, {});
        } else {
            data = JSON.parse(JSON.stringify(INITIAL_DATA));
        }
    }
    function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
    function openTab(evt, tabName) {
        document.querySelectorAll(".tab-content").forEach(c => c.style.display = "none");
        document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.classList.add("active");
    }

    // ********** DASHBOARD METRICS **********
    function calculateMetrics() {
        let suppliesNeeded = 0, meatNeeded = 0, prepNeeded = 0, breadNeeded = 0;
        data.supplies.forEach(item => { suppliesNeeded += Math.max(0, item.standard - item.current); });
        data.meat_thaw.forEach(item => { meatNeeded += Math.max(0, item.standard - item.current); });
        data.prep.forEach(item => { prepNeeded += Math.max(0, item.standard - (item.unit + item.back + item.walk)); });
        data.bread.forEach(item => { breadNeeded += Math.max(0, item.standard - item.current); });

        const dash = document.getElementById('dashboard-metrics');
        dash.innerHTML = `
            ${renderMetricCard('비품 필요', suppliesNeeded, '총합')}
            ${renderMetricCard('미트 해동 필요', meatNeeded, '총합')}
            ${renderMetricCard('재료 준비 필요', prepNeeded, '총합')}
            ${renderMetricCard('빵 필요 개수', breadNeeded, breadNeeded > 0 ? '저녁 대비 부족' : '충분', true)}
        `;
    }
    function renderMetricCard(title, value, summary) {
        const isAlert = value > 0;
        const alertClass = isAlert ? 'alert' : '';
        return `
            <div class="metric-card ${alertClass}" style="border-left-color: ${isAlert ? 'var(--alert-red)' : 'var(--primary-color)'};">
                <h3>${title}</h3>
                <div class="value ${alertClass}">${value}</div>
                <div class="summary">${summary}</div>
            </div>
        `;
    }
    
    // ********** GENERAL RENDER & UPDATE FUNCTIONS **********
    function renderApp() {
        calculateMetrics();
        renderSuppliesTable();
        renderMeatTable();
        renderPrepTable();
        renderBreadTable();
        renderCashDetailTable();
        renderInventoryTables();
        renderChecklist();
        calculateCash(); 
    }

    function updateData(input, type, field, isNumeric = true) {
        const index = input.getAttribute('data-index');
        let value = input.value;
        
        if (isNumeric) { value = parseInt(value) || 0; }

        data[type][index][field] = value;
        saveData();

        switch(type) {
            case 'supplies': renderSuppliesTable(); break;
            case 'meat_thaw': renderMeatTable(); break;
            case 'prep': renderPrepTable(); break;
            case 'bread': renderBreadTable(); break;
        }
        calculateMetrics();
    }
    
    function deleteItem(type, index) {
        if(confirm('정말 이 항목을 삭제하시겠어요?')) {
            data[type].splice(index, 1);
            saveData();
            renderApp();
        }
    }

    // ********** SPECIFIC TAB RENDER FUNCTIONS **********

    // 1. 마감비품표
    function renderSuppliesTable() {
        const tbody = document.getElementById('supplies-table').querySelector('tbody');
        tbody.innerHTML = '';
        data.supplies.forEach((item, index) => {
            const needed = Math.max(0, item.standard - item.current);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.name}</td>
                <td><input type="number" data-index="${index}" data-field="standard" value="${item.standard}" oninput="updateData(this, 'supplies', 'standard')" /></td>
                <td><input type="number" data-index="${index}" data-field="current" value="${item.current}" oninput="updateData(this, 'supplies', 'current')" /></td>
                <td class="need-count ${needed > 0 ? 'alert' : ''}">${needed}</td>
                <td><i class="fas fa-trash-alt" style="color: #ccc; cursor:pointer;" onclick="deleteItem('supplies', ${index})"></i></td>
            `;
            tbody.appendChild(tr);
        });
    }
    
    // 2. 미트 해동표
    function renderMeatTable() {
        const tbody = document.getElementById('meat-table').querySelector('tbody');
        tbody.innerHTML = '';
        data.meat_thaw.forEach((item, index) => {
            const needed = Math.max(0, item.standard - item.current);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.name}</td>
                <td><input type="number" data-index="${index}" data-field="standard" value="${item.standard}" oninput="updateData(this, 'meat_thaw', 'standard')" /></td>
                <td><input type="number" data-index="${index}" data-field="current" value="${item.current}" oninput="updateData(this, 'meat_thaw', 'current')" /></td>
                <td class="need-count ${needed > 0 ? 'alert' : ''}">${needed}</td>
                <td><i class="fas fa-trash-alt" style="color: #ccc; cursor:pointer;" onclick="deleteItem('meat_thaw', ${index})"></i></td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 3. 미트재료준비표
    function renderPrepTable() {
        const tbody = document.getElementById('prep-table').querySelector('tbody');
        tbody.innerHTML = '';
        data.prep.forEach((item, index) => {
            const total = item.unit + item.back + item.walk;
            const needed = Math.max(0, item.standard - total);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.name}</td>
                <td><input type="number" data-index="${index}" data-field="standard" value="${item.standard}" oninput="updateData(this, 'prep', 'standard')" /></td>
                <td><input type="number" data-index="${index}" data-field="unit" value="${item.unit}" oninput="updateData(this, 'prep', 'unit')" /></td>
                <td><input type="number" data-index="${index}" data-field="back" value="${item.back}" oninput="updateData(this, 'prep', 'back')" /></td>
                <td><input type="number" data-index="${index}" data-field="walk" value="${item.walk}" oninput="updateData(this, 'prep', 'walk')" /></td>
                <td>${total}</td>
                <td class="need-count ${needed > 0 ? 'alert' : ''}">${needed}</td>
                <td><i class="fas fa-trash-alt" style="color: #ccc; cursor:pointer;" onclick="deleteItem('prep', ${index})"></i></td>
            `;
            tbody.appendChild(tr);
        });
    }
    
    // 4. 빵 해동표
    function renderBreadTable() {
        const tbody = document.getElementById('bread-table').querySelector('tbody');
        tbody.innerHTML = '';
        data.bread.forEach((item, index) => {
            const neededCurrent = Math.max(0, item.standard - item.current);
            const neededThaw = Math.max(0, neededCurrent - item.defrost); 
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.name}</td>
                <td><input type="number" data-index="${index}" data-field="standard" value="${item.standard}" oninput="updateData(this, 'bread', 'standard')" /></td>
                <td><input type="number" data-index="${index}" data-field="current" value="${item.current}" oninput="updateData(this, 'bread', 'current')" /></td>
                <td class="need-count ${neededCurrent > 0 ? 'alert' : ''}">${neededCurrent}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 5. 마감시트표: 현금 정산 계산
    function calculateCash() {
        const cCount = parseInt(document.getElementById('cash-in-1').value) || 0;
        const c_out_2 = parseInt(document.getElementById('cash-out-2').value) || 0;
        const c_out_3 = parseInt(document.getElementById('cash-out-3').value) || 0;
        const posIn = parseInt(document.getElementById('cash-in-5').value) || 0;

        // (1)-(4) 계산: (1) 현금매출 - (2) 지출 + (3) 금고출금
        const actualCash = (cCount) - c_out_2 + c_out_3;
        const difference = posIn - actualCash;

        document.getElementById('cash-out-4').textContent = actualCash.toLocaleString() + ' 원';
        const diffElement = document.getElementById('cash-difference');
        diffElement.textContent = difference.toLocaleString() + ' 원';
        
        diffElement.className = (difference >= 0) ? 'ok' : 'error';

        data.cash = { cash1000: c1000Count, cash_out_2: c_out_2, cash_out_3: c_out_3, pos_cash: posIn };
        saveData();
    }

    // 마감시트표: 권종별 입/출금 상세
    function renderCashDetailTable() {
        const tbody = document.getElementById('cash-detail-table');
        tbody.innerHTML = '';
        const denominations = ["50000", "10000", "5000", "1000"];
        let totalIn = 0;
        let totalOut = 0;

        denominations.forEach(denom => {
            const d = parseInt(denom);
            const item = data.cash_detail[denom];
            const inAmount = item.in * d;
            const outAmount = item.out * d;
            totalIn += inAmount;
            totalOut += outAmount;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${d.toLocaleString()}원</td>
                <td><input type="number" data-denom="${denom}" data-type="in" value="${item.in}" oninput="updateCashDetail(this)" /></td>
                <td><input type="number" data-denom="${denom}" data-type="out" value="${item.out}" oninput="updateCashDetail(this)" /></td>
                <td>${inAmount.toLocaleString()}</td>
                <td>${outAmount.toLocaleString()}</td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('total-in').textContent = totalIn.toLocaleString() + ' 원';
        document.getElementById('total-out').textContent = totalOut.toLocaleString() + ' 원';
    }

    function updateCashDetail(input) {
        const denom = input.getAttribute('data-denom');
        const type = input.getAttribute('data-type');
        const value = parseInt(input.value) || 0;
        
        data.cash_detail[denom][type] = value;
        saveData();
        renderCashDetailTable();
    }
    
    // 마감시트표: 지하/지상 재고
    function renderInventoryTables() {
        const renderTable = (id, items) => {
            const tbody = document.getElementById(id).querySelector('tbody');
            tbody.innerHTML = '';
            items.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = 'inventory-item';
                tr.innerHTML = `
                    <td>${item.name} (${item.unit})</td>
                    <td><input type="number" data-index="${index}" data-type="${id}" data-field="current" value="${item.current}" oninput="updateInventory(this)" /></td>
                `;
                tbody.appendChild(tr);
            });
        };

        renderTable('inv-basement', data.inv_basement);
        renderTable('inv-ground', data.inv_ground);
        renderTable('inv-cambro', data.inv_cambro);
    }

    function updateInventory(input) {
        const index = input.getAttribute('data-index');
        const type = input.getAttribute('data-type').replace('inv-', ''); // basement, ground, cambro
        const value = parseFloat(input.value) || 0; // KG, 개수 등은 소수점 가능

        data[`inv_${type}`][index].current = value;
        saveData();
    }

    // 마감시트표: 기타 정산 및 메모
    function saveEtcCash(type) {
        data.etc_cash[type] = parseInt(document.getElementById(`cash-etc-${type}`).value) || 0;
        saveData();
    }
    function saveMemo(type) {
        data.memo = document.getElementById('memo-field').value;
        saveData();
    }
    function loadEtcAndMemo() {
        document.getElementById('memo-field').value = data.memo || '';
        document.getElementById('cash-etc-sik').value = data.etc_cash.sik;
        document.getElementById('cash-etc-mod').value = data.etc_cash.mod;
        document.getElementById('cash-etc-zer').value = data.etc_cash.zer;
        document.getElementById('cash-etc-acc').value = data.etc_cash.acc;
    }
    
    // 6. 마감 체크리스트 렌더링
    function renderChecklist() {
        const container = document.getElementById('checklist-container');
        container.innerHTML = '';
        let doneCount = 0;

        data.checklist.forEach((item, index) => {
            const isDone = data.checklist_status[index];
            if (isDone) doneCount++;

            const div = document.createElement('div');
            div.className = `checklist-item ${isDone ? 'done' : ''}`;
            div.onclick = (e) => {
                data.checklist_status[index] = !data.checklist_status[index];
                saveData();
                renderChecklist();
            };
            
            div.innerHTML = `<input type="checkbox" ${isDone ? 'checked' : ''} disabled><span>${item}</span>`;
            container.appendChild(div);
        });

        document.getElementById('total-tasks').textContent = data.checklist.length;
        document.getElementById('done-tasks').textContent = doneCount;
    }


    // ********** UTILITY FUNCTIONS (Reset/Export) **********
    function resetData() {
        if(confirm('⚠️ 모든 저장된 데이터가 초기화됩니다. 계속하시겠어요?')) {
            localStorage.removeItem(STORAGE_KEY);
            alert('데이터가 초기화되었습니다. 페이지를 새로고침합니다.');
            window.location.reload();
        }
    }

    function exportData() {
        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'subway_close_data_backup_final.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        alert('데이터를 JSON 파일로 내보냈습니다!');
    }
    
    function printData() {
        alert("인쇄 기능이 활성화됩니다.");
        window.print();
    }


    // 초기화 및 실행
    window.onload = () => {
        loadData();
        renderApp();
        loadEtcAndMemo();

        // 현금 정산 필드 로드 및 계산
        document.getElementById('cash-in-1').value = data.cash.cash1000;
        document.getElementById('cash-out-2').value = data.cash.cash_out_2;
        document.getElementById('cash-out-3').value = data.cash.cash_out_3;
        document.getElementById('cash-in-5').value = data.cash.pos_cash;
        calculateCash(); 
    };
</script>
</body>
</html>